{{/* layouts/books/single.html */}}
{{ define "main" }}
<article class="book-detail max-w-3xl mx-auto p-6 prose">

  {{/* ===== 1) SCRATCH: Google & OpenLibrary Daten holen ===== */}}
  {{ $isbn := .Params.isbn }}
  {{ $gbURL := printf "https://www.googleapis.com/books/v1/volumes?q=isbn:%s" $isbn }}
  {{ $gb := resources.GetRemote $gbURL | transform.Unmarshal }}
  {{ $items := index $gb "items" }}
  {{ $info := dict }}
  {{ if and $items (gt (len $items) 0) }}
    {{ $info = index (index $items 0) "volumeInfo" }}
  {{ end }}
  {{ $olData := dict }}
  {{ with resources.GetRemote (printf "https://openlibrary.org/api/books?bibkeys=ISBN:%s&format=json&jscmd=data" $isbn) | transform.Unmarshal }}
    {{ $olKey := printf "ISBN:%s" $isbn }}
    {{ with index . $olKey }}
      {{ $olData = . }}
    {{ end }}
  {{ end }}

  {{/* ===== 2) HEADER: Titel & Untertitel ===== */}}
  <header class="mb-6">
    <h1 class="text-3xl font-bold">{{ .Title }}</h1>
    {{ with index $info "subtitle" }}
      <h2 class="text-xl text-gray-600 mt-1">{{ . }}</h2>
    {{ end }}
  </header>

  {{/* ===== 3) COVER ===== */}}
  {{ $coverO := .Params.override_cover }}
  {{ if $coverO }}
    <img src="{{ $coverO }}" alt="{{ .Title }} Cover" class="w-full mb-4 border rounded">
  {{ else }}
    {{ $coverURL := index (index $info "imageLinks") "thumbnail" }}
    {{ if not $coverURL }}
      {{ $coverURL = index (index $info "imageLinks") "smallThumbnail" }}
    {{ end }}
    {{ if $coverURL }}
      <img src="{{ $coverURL }}" alt="{{ .Title }} Cover" class="w-full mb-4 border rounded">
    {{ else }}
      {{ $size := .Site.Params.book.imageSizeSingle }}
      {{ $dash := cond (gt (len $size) 0) (printf "-%s" $size) "" }}
      <img
        src="https://covers.openlibrary.org/b/isbn/{{ $isbn }}{{ $dash }}.jpg?default=false"
        alt="{{ .Title }} Cover"
        class="w-full mb-4 border rounded"
        onerror="this.style.display='none'">
    {{ end }}
  {{ end }}

  {{/* ===== 4) METADATEN ===== */}}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <p><strong>{{ i18n "authorLabel" }}:</strong>
        {{ if .Params.override_author }}{{ .Params.override_author }}
        {{ else if index $info "authors" }}{{ index (index $info "authors") 0 }}
        {{ else if index $olData "authors" }}{{ index (index $olData "authors") 0 "name" }}
        {{ else }}–{{ end }}
      </p>
      <p><strong>{{ i18n "publisherLabel" }}:</strong> {{ with index $info "publisher" }}{{ . }}{{ else if index $olData "publishers" }}{{ index (index $olData "publishers") 0 }}{{ else }}–{{ end }}</p>
      <p><strong>{{ i18n "publishedDateLabel" }}:</strong> {{ with index $info "publishedDate" }}{{ . }}{{ else }}–{{ end }}</p>
    </div>
    <div>
      <p><strong>{{ i18n "pagesLabel" }}:</strong>
        {{ if gt .Params.override_pages 0 }}{{ .Params.override_pages }}
        {{ else if index $info "pageCount" }}{{ index $info "pageCount" }}
        {{ else if index $olData "number_of_pages" }}{{ index $olData "number_of_pages" }}
        {{ else }}–{{ end }}
      </p>
      <p><strong>{{ i18n "descriptionLabel" }}:</strong>
        {{ if .Params.override_description }}{{ .Params.override_description }}
        {{ else if index $info "description" }}{{ index $info "description" }}
        {{ else if index $olData "description" }}{{ index $olData "description" }}
        {{ else }}–{{ end }}
      </p>
      <p><strong>{{ i18n "priceLabel" }}:</strong>
        {{ if .Params.override_price }}{{ printf "%s Euro" .Params.override_price }}{{ else }}–{{ end }}
      </p>
    </div>
  </div>

  {{/* ===== 5) RATING ===== */}}
  <div class="mt-6">
    <p><strong>{{ i18n "ratingLabel" }}:</strong>
      {{ $r := .Params.rating }}
      {{ range seq 5 }}
        {{ if ge $r . }}<span class="text-yellow-500">★</span>{{ else }}<span class="text-gray-300">★</span>{{ end }}
      {{ end }}
    </p>
  </div>

  {{/* ===== 6) KOMMENTAR ===== */}}
  {{ if .Params.comment }}
    <section class="mt-6">
      <h3 class="text-xl font-semibold mb-2">{{ i18n "commentTitle" }}</h3>
      {{ .Params.comment | markdownify }}
    </section>
  {{ end }}

  {{/* ===== 7) TAGS ===== */}}
  {{ $tags := cond (eq (printf "%T" .Params.tags) "string") (slice .Params.tags) .Params.tags }}
  <p class="mt-6"><strong>{{ i18n "tagsLabel" }}:</strong>
    {{ range $i, $tag := $tags }}
      <a href="{{ "/tags/" | relLangURL }}{{ $tag | urlize }}" class="text-blue-600 hover:underline">{{ $tag }}</a>{{ if lt (add $i 1 (len $tags)) }} , {{ end }}
    {{ end }}
  </p>

</article>
{{ end }}
