{{ define "main" }}
{{ partial "page-header" . }}

<section class="section pt-7">
  <div class="container">
    <div class="row justify-center">
      <article class="lg:col-10">

        <h1 class="text-3xl font-bold mb-6">{{ i18n "bookListTitle" }}</h1>

        {{/* Suchfeld */}}
        <div class="mb-6">
          <input type="text" id="searchInput" placeholder="Suche nach Titel oder Autor..."
            class="w-full p-2 border rounded" oninput="filterBooks()" />
        </div>

        {{/* Bewertungsfilter */}}
        <div class="mb-6">
          <label for="ratingFilter"><strong>Minimale Bewertung:</strong></label>
          <select id="ratingFilter" onchange="filterBooks()" class="ml-2 p-1 border rounded">
            <option value="0">Alle</option>
            {{ range seq 1 5 }}
              <option value="{{ . }}">{{ . }} ★ & höher</option>
            {{ end }}
          </select>
        </div>

        {{/* TAGS */}}
        <p><strong>{{ i18n "tagsLabel" }}:</strong>
        {{ $allTags := slice }}
        {{ range .Pages }}
          {{ range .Params.tags }}
            {{ $allTags = $allTags | append . }}
          {{ end }}
        {{ end }}
        {{ $uniqueTags := uniq $allTags | sort }}
        <nav class="filters mb-8">
          {{ range $uniqueTags }}
            <a href="{{ "/tags/" | relLangURL }}{{ . | urlize }}"
              class="inline-block px-3 py-1 mr-2 mb-2 bg-gray-200 rounded-full text-sm hover:bg-gray-300">
              {{ . }}
            </a>
          {{ end }}
        </nav>

        {{/* AUTOREN */}}
        <p><strong>{{ i18n "authorLabel" }}:</strong>
        {{ $allAuthors := slice }}
        {{ range .Pages }}
          {{ $ap := .Params.authors }}
          {{ if $ap }}
            {{ if eq (printf "%T" $ap) "string" }}
              {{ $allAuthors = $allAuthors | append $ap }}
            {{ else }}
              {{ range $ap }}
                {{ $allAuthors = $allAuthors | append . }}
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
        {{ $uniqueAuthors := uniq $allAuthors | sort }}
        <nav class="filters mb-8">
          {{ range $uniqueAuthors }}
            <a href="{{ "/authors/" | relLangURL }}{{ . | urlize }}"
              class="inline-block px-3 py-1 mr-2 mb-2 bg-gray-200 rounded-full text-sm hover:bg-gray-300">
              {{ . }}
            </a>
          {{ end }}
        </nav>

        {{/* BOOK GRID */}}
        <div id="bookGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          {{ $size := .Site.Params.book.imageSizeList }}
          {{ $dash := cond (gt (len $size) 0) (printf "-%s" $size) "" }}
          {{ $paginator := .Paginate (.Pages.ByDate.Reverse) }}
          {{ range $paginator.Pages }}
            <article class="book-card border rounded-lg overflow-hidden shadow hover:shadow-lg transition-shadow duration-200" data-title="{{ .Title | lower }}" data-author="{{ with .Params.override_author }}{{ . | lower }}{{ else }}{{ with index .Params.authors 0 }}{{ . | lower }}{{ end }}{{ end }}" data-rating="{{ .Params.rating }}">
              <a href="{{ .Permalink }}">
                {{ with .Params.override_cover }}
                  <img src="{{ . }}" alt="{{ $.Title }} Cover" class="w-full h-48 object-cover">
                {{ else }}
                  <img src="https://covers.openlibrary.org/b/isbn/{{ .Params.isbn }}{{ $dash }}.jpg?default=false"
                    alt="{{ .Title }} Cover" class="w-full h-48 object-cover" onerror="this.style.display='none'">
                {{ end }}
                <div class="p-4">
                  <h2 class="text-lg font-semibold mb-1">{{ .Title }}</h2>
                  <p class="text-sm text-gray-600">
                    {{ with .Params.override_author }}{{ . }}{{ else }}{{ index .Params.authors 0 }}{{ end }}
                  </p>
                  <p>
                    {{ $r := .Params.rating }}
                    {{ range seq 5 }}
                      {{ if ge $r . }}<span class="text-yellow-500 text-xl">★</span>{{ else }}<span class="text-gray-300 text-xl">★</span>{{ end }}
                    {{ end }}
                  </p>
                </div>
              </a>
            </article>
          {{ end }}
        </div>

        {{/* PAGINATION */}}
        <div class="mt-8">
          {{ partial "pagination.html" . }}
        </div>

      </article>
    </div>
  </div>
</section>

<script>
  function filterBooks() {
    const search = document.getElementById("searchInput").value.toLowerCase();
    const rating = parseInt(document.getElementById("ratingFilter").value || "0");
    const books = document.querySelectorAll("#bookGrid article");

    books.forEach(book => {
      const title = book.dataset.title || "";
      const author = book.dataset.author || "";
      const bookRating = parseInt(book.dataset.rating || "0");
      const matchesSearch = title.includes(search) || author.includes(search);
      const matchesRating = bookRating >= rating;
      book.style.display = (matchesSearch && matchesRating) ? "" : "none";
    });
  }
</script>
{{ end }}
