{{/* layouts/partials/book-meta.html */}}
{{ $isbn   := .Params.isbn }}
{{ $author := .Params.override_author }}
{{ $pages  := .Params.override_pages }}
{{ $desc   := .Params.override_description }}
{{ $price  := .Params.override_price }}

{{ if $isbn }}

  {{/* ==== 1) COVER: Google Books zuerst ==== */}}
  {{ $gbURL   := printf "https://www.googleapis.com/books/v1/volumes?q=isbn:%s" $isbn }}
  {{ $gb      := resources.GetRemote $gbURL | transform.Unmarshal }}
  {{ $items   := index $gb "items" }}
  {{ if and $items (gt (len $items) 0) }}
    {{ $info     := index (index $items 0) "volumeInfo" }}
    {{ with index $info "imageLinks" }}
      {{ $links    := . }}
      {{ $coverURL := or (index $links "thumbnail") (index $links "smallThumbnail") }}
      {{ if $coverURL }}
        <img 
          src="{{ $coverURL }}" 
          alt="{{ $.Title }} Cover" 
          class="w-full mb-4 border rounded">
      {{ end }}
    {{ end }}
  {{ else }}
    {{/* ==== 2) FALLBACK: OpenLibrary ==== */}}
    {{ $size := .Site.Params.book.imageSizeSingle }}
    {{ $dash := cond (gt (len $size) 0) (printf "-%s" $size) "" }}
    <img 
      src="https://covers.openlibrary.org/b/isbn/{{ $isbn }}{{ $dash }}.jpg?default=false" 
      alt="{{ .Title }} Cover" 
      class="w-full mb-4 border rounded" 
      onerror="this.style.display='none'">
  {{ end }}

  {{/* ==== 3) METADATEN ==== */}}
  <p><strong>{{ i18n "authorLabel" }}:</strong>
    {{ if $author }}{{ $author }}{{ else }}
      {{/* aus Google oder OpenLibrary (falls im $info) */}}
      {{ with index $info "authors" }}{{ index . 0 }}{{ else }}–{{ end }}
    {{ end }}
  </p>

  <p><strong>{{ i18n "pagesLabel" }}:</strong>
    {{ if gt $pages 0 }}{{ $pages }}{{ else }}
      {{ with index $info "pageCount" }}{{ . }}{{ else }}–{{ end }}
    {{ end }}
  </p>

  <p><strong>{{ i18n "descriptionLabel" }}:</strong>
    {{ if $desc }}{{ $desc }}{{ else }}
      {{ with index $info "description" }}{{ . }}{{ else }}–{{ end }}
    {{ end }}
  </p>

  <p><strong>{{ i18n "priceLabel" }}:</strong> {{ if $price }}{{ $price }}{{ else }}k.A.{{ end }}</p>

  <p><strong>{{ i18n "buyLabel" }}:</strong>
    {{ range .Site.Params.book.buyLinks }}
      <a href="{{ replace .url \"{{.ISBN}}\" $isbn }}">{{ .name }}</a>
    {{ end }}
  </p>

{{ end }}
