{{/* layouts/partials/book-meta.html */}}
{{ $isbn := .Params.isbn }}
{{ $author := .Params.override_author }}
{{ $pages := .Params.override_pages }}
{{ $desc := .Params.override_description }}
{{ $price := .Params.override_price }}
{{ if $isbn }}
  {{/* 1) Versuch: OpenLibrary */}}
  {{ $olURL := printf "https://openlibrary.org/api/books?bibkeys=ISBN:%s&format=json&jscmd=data" $isbn }}
  {{ $ol := resources.GetRemote $olURL | transform.Unmarshal }}
  {{ $book := index $ol (printf "ISBN:%s" $isbn) }}

  {{/* 2) Google Fallback, falls OL leer */}}
  {{ if not $book }}
    {{ $gbURL := printf "https://www.googleapis.com/books/v1/volumes?q=isbn:%s" $isbn }}
    {{ $gb := resources.GetRemote $gbURL | transform.Unmarshal }}
    {{ $items := index $gb "items" }}
    {{ if and $items (gt (len $items) 0) }}
      {{ $item0 := index $items 0 }}
      {{ $info := index $item0 "volumeInfo" }}
      {{ $coverURL := "" }}
      {{ with index $info "imageLinks" }}
        {{ $coverURL = index . "thumbnail" }}
      {{ end }}
      {{ if $coverURL }}
        <img src="{{ $coverURL }}" alt="{{ .Title }} Cover" class="w-full mb-4 border rounded">
      {{ end }}
      {{ $book = dict "authors" (index $info "authors") "number_of_pages" (index $info "pageCount") "description" (index $info "description") }}
    {{ end }}
  {{ else }}
    {{/* 3) Standard-Cover von OpenLibrary */}}
    <img src="https://covers.openlibrary.org/b/isbn/{{ $isbn }}-L.jpg?default=false" alt="{{ .Title }} Cover" class="w-full mb-4 border rounded">
  {{ end }}

  {{/* Metadaten aus $book oder Overrides anzeigen */}}
  <p><strong>{{ i18n "authorLabel" }}:</strong> {{ if $author }}{{ $author }}{{ else }}{{ index (index $book "authors") 0 }}{{ end }}</p>
  <p><strong>{{ i18n "pagesLabel" }}:</strong> {{ if gt $pages 0 }}{{ $pages }}{{ else }}{{ index $book "number_of_pages" }}{{ end }}</p>
  <p><strong>{{ i18n "descriptionLabel" }}:</strong>
    {{ if $desc }}{{ $desc }}{{ else }}{{ with index $book "description" }}{{ . }}{{ else }}â€“{{ end }}{{ end }}
  </p>
  <p><strong>{{ i18n "priceLabel" }}:</strong> {{ if $price }}{{ $price }}{{ else }}k.A.{{ end }}</p>
  <p><strong>{{ i18n "buyLabel" }}:</strong>
    {{ range .Site.Params.book.buyLinks }}
      <a href="{{ replace .url "{{.ISBN}}" $isbn }}">{{ .name }}</a>
    {{ end }}
  </p>
{{ end }}
